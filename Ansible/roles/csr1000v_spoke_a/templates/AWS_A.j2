vrf definition internet-vrf
 rd 1:1
 !
 address-family ipv4
 exit-address-family
!
redundancy
! 
crypto keyring internet-key vrf internet-vrf 
  pre-shared-key address 0.0.0.0 0.0.0.0 key {{DMVPN_Key}}
!
!
crypto isakmp policy 10
 encr aes 256
 hash sha256
 authentication pre-share
crypto isakmp keepalive 10 10
crypto isakmp profile isakmp-prof
   keyring internet-key
   match identity address 0.0.0.0 internet-vrf
!
crypto ipsec security-association replay window-size 128
!
crypto ipsec transform-set xform esp-aes 256 esp-sha256-hmac 
 mode transport
crypto ipsec df-bit clear
!
!
crypto ipsec profile ipsec-prof
 set transform-set xform 
 set isakmp-profile isakmp-prof
!
interface Tunnel1
 description DMVPN
 ip address {{Tunnel.1.IP}} 255.255.0.0
 no ip redirects
 ip mtu 1400
 ip nhrp network-id 100
 ip nhrp nhs 10.254.1.1 nbma 34.225.25.54 multicast
 ip nhrp nhs 10.254.2.1 nbma 52.40.21.159 multicast
 ip nhrp nhs 10.254.1.2 nbma 34.226.68.69 multicast
 ip nhrp nhs 10.254.2.2 nbma 52.40.115.65 multicast
 ip nhrp shortcut
 ip tcp adjust-mss 1360
 tunnel source GigabitEthernet1
 tunnel mode gre multipoint
 tunnel key 1
 tunnel vrf internet-vrf
 tunnel protection ipsec profile ipsec-prof
!
router bgp 65500
 bgp router-id {{Tunnel.1.IP}}
 bgp log-neighbor-changes
 neighbor AWS_EAST peer-group
 neighbor AWS_EAST remote-as 65500
 neighbor AWS_EAST update-source Tunnel1
 neighbor AWS_WEST peer-group
 neighbor AWS_WEST remote-as 65500
 neighbor AWS_WEST update-source Tunnel1
 neighbor 10.254.1.1 peer-group AWS_EAST
 neighbor 10.254.1.2 peer-group AWS_EAST
 neighbor 10.254.2.1 peer-group AWS_WEST
 neighbor 10.254.2.2 peer-group AWS_WEST
 !
 address-family ipv4
  redistribute static
  neighbor AWS_EAST next-hop-self
  neighbor AWS_WEST next-hop-self
  neighbor 10.254.1.1 activate
  neighbor 10.254.1.2 activate
  neighbor 10.254.2.1 activate
  neighbor 10.254.2.2 activate
 exit-address-family
!
ip route {{VPC_CIDR.IP}} {{VPC_CNetmask.IP}} {{VPC_CIDR_NH.IP}}
!
no ip http server
ip http secure-server
!
line con 0
 stopbits 1
line vty 0 4
 login local
 transport input ssh
!
ntp server pool.ntp.org
event manager applet fvrf
 event none
 action 1.0 cli command "enable"
 action 1.1 cli command "config t"
 action 1.2 cli command "ip route vrf internet-vrf 0.0.0.0 0.0.0.0 {{EEM_ROUTE_NH.IP}}"
 action 1.3 cli command "interface gig1"
 action 1.4 cli command "vrf forwarding internet-vrf"
 action 1.5 cli command "ip address {{EEM_G1.IP}} 255.255.255.240"
 action 2.0 cli command "end"
