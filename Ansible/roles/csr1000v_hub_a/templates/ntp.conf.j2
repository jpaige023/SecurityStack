vrf definition internet-vrf
 rd 1:1

 address-family ipv4
 exit-address-family

crypto keyring internet-key vrf internet-vrf
  pre-shared-key address 0.0.0.0 0.0.0.0 key {{dmvpn_key}}

crypto isakmp policy 10
 encr aes 256
 hash sha256
 authentication pre-share

crypto isakmp keepalive 10 10
crypto isakmp profile isakmp-prof
   keyring internet-key
   match identity address 0.0.0.0 internet-vrf

crypto ipsec security-association replay window-size 128

crypto ipsec transform-set xform esp-aes 256 esp-sha256-hmac
 mode transport

crypto ipsec df-bit clear

crypto ipsec profile ipsec-prof
 set transform-set xform
 set isakmp-profile isakmp-prof

interface Tunnel{{dmvpn_tunnel}}
 description DMVPN
 ip address {{tunnel_address}} 255.255.0.0
 no ip redirects
 ip mtu 1400
 ip pim sparse-mode
 ip nhrp network-id 100
 ip nhrp nhs 10.254.2.1 nbma 52.40.21.159 multicast
 ip nhrp nhs 10.254.2.2 nbma 52.40.115.65 multicast
 ip nhrp nhs 10.254.1.2 nbma 34.226.68.69 multicast
 ip nhrp redirect
 ip tcp adjust-mss 1360
 tunnel source GigabitEthernet1
 tunnel mode gre multipoint
 tunnel key 1
 tunnel vrf internet-vrf
 tunnel protection ipsec profile ipsec-prof
!

interface GigabitEthernet1
 vrf forwarding internet-vrf
 ip address {{router_a_address_g1}} 255.255.255.240
 negotiation auto
!
interface GigabitEthernet2
 ip address {{router_a_address_g2}} {{router_a_subnet_mask_g2}}
 ip access-group cloudWhiteListPolicy in
 ip access-group cloudWhiteListPolicy out
 negotiation auto


router bgp 65500
 bgp router-id {{tunnel_address}}
 bgp log-neighbor-changes
 bgp listen range 10.254.0.0/16 peer-group DMVPNSPOKES
 bgp listen limit 1000
 neighbor DMVPNSPOKES peer-group
 neighbor DMVPNSPOKES remote-as 65500
 neighbor DMVPNSPOKES update-source Tunnel1
 neighbor 10.254.1.2 remote-as 65500
 neighbor 10.254.1.2 update-source Tunnel1
 neighbor 10.254.2.1 remote-as 65500
 neighbor 10.254.2.1 update-source Tunnel1
 neighbor 10.254.2.2 remote-as 65500
 neighbor 10.254.2.2 update-source Tunnel1
 !
 address-family ipv4
  network 10.0.1.16 mask 255.255.255.240
  network 10.100.1.0 mask 255.255.255.252
  neighbor DMVPNSPOKES activate
  neighbor DMVPNSPOKES route-reflector-client
  neighbor 10.254.1.2 activate
  neighbor 10.254.2.1 activate
  neighbor 10.254.2.2 activate
  exit-address-family

ip route vrf internet-vrf 0.0.0.0 0.0.0.0 10.0.1.1

event manager applet fvrf
 event none
 action 1.0 cli command "enable"
 action 1.1 cli command "config t"
 action 1.2 cli command "ip route vrf internet-vrf 0.0.0.0 0.0.0.0 10.0.1.1"
 action 1.3 cli command "interface gig1"
 action 1.4 cli command "vrf forwarding internet-vrf"
 action 1.5 cli command "ip address 10.0.1.5 255.255.255.240"
 action 2.0 cli command "end"
